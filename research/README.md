## Исследование: выбор хранилища

Цель исследования - определиться с выбором СУБД в качестве хранилища аналитических данных и оценить ее возможности для хранения и извлечения временных меток

В исследовании сравниваются колоночные СУБД ClickHouse и Vertica и клиентские библиотеки для работы с ними на Python

Исследование проходит в 3 этапа:

### 1. Подготовка базы данных

На этом этапе создается таблица, генерируются и загружаются исходные данные. Объем исходных данных регулируется переменной `INITIAL_ROWS_COUNT`

### 2. Замеры времени отклика в однопоточном режиме

- Замер времени загрузки 100 000 строк методом, специфичным для исследуемой СУБД
- Замер времени выборки последней записи для конкретных фильма и пользователя - момента, на котором пользователь закончил просмотр
- Замер времени агрегации и выборки наиболее просматриваемых фильмов - для задач аналитики

### 3. Замеры времени отклика под нагрузкой

На этом этапе, как и на предыдущем, производятся замеры времени выборки, но при этом моделируется нагрузка на СУБД. В отдельных потоках производится запись данных в очередь со скоростью `STRESS_TESTS_WPS` строк в секунду и загрузка этих данных в базу

### 4. Замеры времени отклика при параллельном чтении

На этом этапе производятся замеры среднего времени выполнения запросов на чтение (последняя временная метка и наиболее просматриваемые фильмы) при параллельной работе нескольких клиентов

### Запуск тестового стенда

Запуск производится командой `make research_db`. При этом поднимаются контейнеры СУБД и контейнер тестового стенда, результаты замеров выводятся в консоль, а после завершения тестирования все контейнеры останавливаются

При использовании настроек по умолчанию на ПК с Intel Core i3-10100 CPU @ 3.60GHz / 16GiB System Memory время исследования составляет **390 секунд**

### Результаты исследования

Результаты исследования зависят от характеристик ПК и настроек Docker, но их можно использовать в качестве сравнительных характеристик

```
Running speed tests
- Initial rows:     10000000
- Stress tests WPS: 10000
- Readers count:    10

DBMS:                                    ClickHouse
- Insert 100k rows:                       0.363298 s
- Retrieve last timecode:                 0.004817 s
- Retrieve last timecode under load:      0.005031 s
- Retrieve last timecode in parallel:     0.021528 s
- Retrieve most viewed films:             0.091464 s
- Retrieve most viewed films under load:  0.095282 s
- Retrieve most viewed films in parallel: 0.858753 s

DBMS:                                    Vertica
- Insert 100k rows:                       1.686621 s
- Retrieve last timecode:                 0.035702 s
- Retrieve last timecode under load:      0.035024 s
- Retrieve last timecode in parallel:     0.234355 s
- Retrieve most viewed films:             0.178715 s
- Retrieve most viewed films under load:  0.190092 s
- Retrieve most viewed films in parallel: 1.054731 s
```

Очевидным выбором среди исследуемых СУБД является ClickHouse
